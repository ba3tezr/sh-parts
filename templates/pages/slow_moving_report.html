{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "تقرير القطع بطيئة الحركة" %} - SH Parts{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
{% endblock %}

{% block extra_css %}
<style>
.report-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-card);
}

.report-card h5 {
    color: var(--primary);
    border-bottom: 2px solid var(--primary);
    padding-bottom: 10px;
    margin-bottom: 20px;
    font-weight: 600;
}

.age-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.age-badge.warning {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: white;
}

.age-badge.danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
}

.age-badge.critical {
    background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
    color: white;
}

.action-btn {
    padding: 4px 8px;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h2><i class="bi bi-hourglass-split me-2"></i>{% trans "تقرير القطع بطيئة الحركة" %}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">{% trans "الرئيسية" %}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'inventory' %}">{% trans "المخزون" %}</a></li>
                    <li class="breadcrumb-item active">{% trans "القطع بطيئة الحركة" %}</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel me-2"></i>{% trans "تصدير Excel" %}
            </button>
            <button class="btn btn-secondary" onclick="window.print()">
                <i class="bi bi-printer me-2"></i>{% trans "طباعة" %}
            </button>
            <a href="{% url 'inventory' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-right me-2"></i>{% trans "رجوع" %}
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="report-card text-center">
                <h3 class="text-warning" id="count30">0</h3>
                <p class="mb-0">{% trans "30-60 يوم" %}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="report-card text-center">
                <h3 class="text-warning" id="count60">0</h3>
                <p class="mb-0">{% trans "60-90 يوم" %}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="report-card text-center">
                <h3 class="text-danger" id="count90">0</h3>
                <p class="mb-0">{% trans "90-180 يوم" %}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="report-card text-center">
                <h3 class="text-danger" id="count180">0</h3>
                <p class="mb-0">{% trans "+180 يوم" %}</p>
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="report-card">
        <h5><i class="bi bi-list-ul me-2"></i>{% trans "القطع بطيئة الحركة" %}</h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>{% trans "القطعة" %}</th>
                        <th>{% trans "الكمية" %}</th>
                        <th>{% trans "عمر القطعة" %}</th>
                        <th>{% trans "السعر الحالي" %}</th>
                        <th>{% trans "السعر المقترح" %}</th>
                        <th class="no-print">{% trans "إجراءات" %}</th>
                    </tr>
                </thead>
                <tbody id="itemsTable">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">{% trans "جاري التحميل..." %}</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allItems = [];

document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

async function loadData() {
    try {
        showLoading();
        
        // تحميل جميع القطع المتوفرة
        allItems = await app.apiRequest('/api/inventory/items/?status=AVAILABLE');
        
        // حساب عمر كل قطعة
        const today = new Date();
        allItems = allItems.map(item => {
            const addedDate = new Date(item.added_at);
            const ageInDays = Math.floor((today - addedDate) / (1000 * 60 * 60 * 24));
            return { ...item, ageInDays };
        });
        
        // فلترة القطع بطيئة الحركة (أكثر من 30 يوم)
        allItems = allItems.filter(item => item.ageInDays >= 30);
        
        // ترتيب حسب العمر (الأقدم أولاً)
        allItems.sort((a, b) => b.ageInDays - a.ageInDays);
        
        displayStatistics();
        displayItems();
        
    } catch (error) {
        console.error('Error loading data:', error);
        actionModals.showInfoModal({
            title: 'خطأ',
            message: 'فشل تحميل البيانات: ' + error.message,
            type: 'error'
        });
    } finally {
        hideLoading();
    }
}

function displayStatistics() {
    let count30 = 0, count60 = 0, count90 = 0, count180 = 0;
    
    allItems.forEach(item => {
        if (item.ageInDays >= 30 && item.ageInDays < 60) count30++;
        else if (item.ageInDays >= 60 && item.ageInDays < 90) count60++;
        else if (item.ageInDays >= 90 && item.ageInDays < 180) count90++;
        else if (item.ageInDays >= 180) count180++;
    });
    
    document.getElementById('count30').textContent = count30;
    document.getElementById('count60').textContent = count60;
    document.getElementById('count90').textContent = count90;
    document.getElementById('count180').textContent = count180;
}

function displayItems() {
    const tbody = document.getElementById('itemsTable');
    const currencySymbol = 'EGP';
    
    if (allItems.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="mt-3 text-muted">لا توجد قطع بطيئة الحركة</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    allItems.forEach(item => {
        const ageBadge = getAgeBadge(item.ageInDays);
        const currentPrice = parseFloat(item.selling_price) || 0;
        const suggestedPrice = getSuggestedPrice(currentPrice, item.ageInDays);
        const discount = ((currentPrice - suggestedPrice) / currentPrice * 100).toFixed(0);
        
        html += `
            <tr>
                <td><code>${item.sku}</code></td>
                <td>${item.part_details?.name_ar || item.part_details?.name || '-'}</td>
                <td><span class="badge bg-secondary">${item.quantity}</span></td>
                <td>${ageBadge}</td>
                <td><del>${currentPrice.toFixed(2)} ${currencySymbol}</del></td>
                <td>
                    <strong class="text-success">${suggestedPrice.toFixed(2)} ${currencySymbol}</strong>
                    <small class="text-muted">(${discount}% خصم)</small>
                </td>
                <td class="no-print">
                    <button class="btn btn-sm btn-primary action-btn" onclick="applyDiscount(${item.id}, ${suggestedPrice})">
                        <i class="bi bi-check"></i> تطبيق
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function getAgeBadge(days) {
    if (days >= 180) {
        return `<span class="age-badge critical">${days} يوم</span>`;
    } else if (days >= 90) {
        return `<span class="age-badge danger">${days} يوم</span>`;
    } else {
        return `<span class="age-badge warning">${days} يوم</span>`;
    }
}

function getSuggestedPrice(currentPrice, ageInDays) {
    // اقتراح خصم بناءً على العمر
    let discountPercent = 0;
    if (ageInDays >= 180) discountPercent = 30;
    else if (ageInDays >= 90) discountPercent = 20;
    else if (ageInDays >= 60) discountPercent = 15;
    else if (ageInDays >= 30) discountPercent = 10;
    
    return currentPrice * (1 - discountPercent / 100);
}

async function applyDiscount(itemId, newPrice) {
    const confirmed = await actionModals.showConfirmModal({
        title: 'تطبيق الخصم',
        message: `هل تريد تطبيق السعر الجديد؟`,
        confirmText: 'تطبيق',
        cancelText: 'إلغاء'
    });
    
    if (!confirmed) return;
    
    try {
        showLoading();
        
        await app.apiRequest(`/api/inventory/items/${itemId}/`, {
            method: 'PATCH',
            body: JSON.stringify({ selling_price: newPrice.toFixed(2) })
        });
        
        actionModals.showInfoModal({
            title: 'نجح',
            message: 'تم تطبيق السعر الجديد بنجاح',
            type: 'success'
        });
        
        // إعادة تحميل البيانات
        await loadData();
        
    } catch (error) {
        actionModals.showInfoModal({
            title: 'خطأ',
            message: 'فشل تطبيق السعر: ' + error.message,
            type: 'error'
        });
    } finally {
        hideLoading();
    }
}

function exportToExcel() {
    const currencySymbol = 'EGP';
    const data = allItems.map(item => ({
        'SKU': item.sku,
        'القطعة': item.part_details?.name_ar || item.part_details?.name || '-',
        'الكمية': item.quantity,
        'عمر القطعة (أيام)': item.ageInDays,
        'السعر الحالي': parseFloat(item.selling_price) || 0,
        'السعر المقترح': getSuggestedPrice(parseFloat(item.selling_price) || 0, item.ageInDays),
        'نسبة الخصم %': (((parseFloat(item.selling_price) - getSuggestedPrice(parseFloat(item.selling_price), item.ageInDays)) / parseFloat(item.selling_price)) * 100).toFixed(0)
    }));
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'القطع بطيئة الحركة');
    
    const fileName = `slow_moving_items_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}
</script>
{% endblock %}

