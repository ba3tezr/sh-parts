{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "إدارة الأسعار" %} - SH Parts{% endblock %}
{% block page_title %}{% trans "إدارة الأسعار" %}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>{% trans "ملاحظة:" %}</strong> {% trans "يمكنك تحديث أسعار جميع القطع في المخزون بنسبة معينة أو تحديث كل قطعة على حدة" %}
        </div>
    </div>
</div>

<!-- تحديث جماعي -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-percent me-2"></i>
                    {% trans "تحديث جماعي بالنسبة المئوية" %}
                </h5>
            </div>
            <div class="card-body">
                <form id="bulkUpdateForm">
                    <div class="mb-3">
                        <label class="form-label">{% trans "نوع التحديث" %}</label>
                        <select class="form-select" id="updateType">
                            <option value="increase">{% trans "زيادة الأسعار" %}</option>
                            <option value="decrease">{% trans "تخفيض الأسعار" %}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{% trans "النسبة المئوية (%)" %}</label>
                        <input type="number" class="form-control" id="percentage"
                               min="0" max="100" step="0.1" required
                               placeholder="{% trans 'مثال: 10 لزيادة 10%' %}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{% trans "تطبيق على" %}</label>
                        <select class="form-select" id="applyTo">
                            <option value="all">{% trans "جميع القطع" %}</option>
                            <option value="category">{% trans "فئة معينة" %}</option>
                            <option value="model">{% trans "موديل سيارة معين" %}</option>
                        </select>
                    </div>

                    <div class="mb-3" id="categorySection" style="display: none;">
                        <label class="form-label">{% trans "الفئة" %}</label>
                        <select class="form-select" id="category">
                            <option value="">{% trans "اختر الفئة..." %}</option>
                        </select>
                    </div>

                    <div class="mb-3" id="modelSection" style="display: none;">
                        <label class="form-label">{% trans "موديل السيارة" %}</label>
                        <select class="form-select" id="carModel">
                            <option value="">{% trans "اختر الموديل..." %}</option>
                        </select>
                    </div>

                    <button type="button" class="btn btn-primary btn-lg w-100" onclick="performBulkUpdate()">
                        <i class="bi bi-lightning-charge me-2"></i>
                        {% trans "تطبيق التحديث الجماعي" %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calculator me-2"></i>
                    {% trans "حاسبة الأسعار" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">{% trans "السعر الحالي" %}</label>
                    <input type="number" class="form-control" id="calcCurrentPrice"
                           step="0.01" placeholder="{% trans 'أدخل السعر الحالي' %}">
                </div>

                <div class="mb-3">
                    <label class="form-label">{% trans "نسبة التغيير (%)" %}</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="calcPercentage"
                               step="0.1" placeholder="{% trans 'مثال: 10' %}">
                        <button class="btn btn-success" onclick="calculateNewPrice('increase')">
                            <i class="bi bi-plus"></i> {% trans "زيادة" %}
                        </button>
                        <button class="btn btn-danger" onclick="calculateNewPrice('decrease')">
                            <i class="bi bi-dash"></i> {% trans "تخفيض" %}
                        </button>
                    </div>
                </div>

                <div class="alert alert-secondary">
                    <h6>{% trans "السعر الجديد:" %}</h6>
                    <h3 class="mb-0" id="calcNewPrice">-</h3>
                </div>

                <hr>

                <h6>{% trans "أمثلة سريعة:" %}</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="quickCalc(10, 'increase')">
                        {% trans "زيادة 10%" %}
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickCalc(15, 'increase')">
                        {% trans "زيادة 15%" %}
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="quickCalc(10, 'decrease')">
                        {% trans "تخفيض 10%" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- جدول القطع -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        {% trans "جميع القطع في المخزون" %}
                    </h5>
                    <div>
                        <input type="text" class="form-control" id="searchParts"
                               placeholder="{% trans 'بحث...' %}" style="width: 250px;">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="partsTable">
                        <thead>
                            <tr>
                                <th>{% trans "كود القطعة" %}</th>
                                <th>{% trans "اسم القطعة" %}</th>
                                <th>{% trans "الفئة" %}</th>
                                <th>{% trans "مصدر السيارة" %}</th>
                                <th>{% trans "الكمية" %}</th>
                                <th>{% trans "السعر الحالي" %}</th>
                                <th>{% trans "سعر جديد" %}</th>
                                <th>{% trans "إجراءات" %}</th>
                            </tr>
                        </thead>
                        <tbody id="partsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <button class="btn btn-primary" onclick="loadAllParts()">
                                        <i class="bi bi-download me-2"></i>
                                        {% trans "تحميل القطع" %}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// تحديث حقول الفئة والموديل حسب الاختيار
document.getElementById('applyTo').addEventListener('change', function() {
    const categorySection = document.getElementById('categorySection');
    const modelSection = document.getElementById('modelSection');
    
    categorySection.style.display = this.value === 'category' ? 'block' : 'none';
    modelSection.style.display = this.value === 'model' ? 'block' : 'none';
});

// تحميل جميع القطع
async function loadAllParts() {
    const loadingModal = actionModals.showLoadingModal('{% trans "جاري تحميل القطع..." %}');

    try {
        const data = await app.apiRequest('/api/inventory/items/?page_size=1000');

        actionModals.hideLoadingModal();

        if (data && data.results) {
            displayParts(data.results);
        }
    } catch (error) {
        actionModals.hideLoadingModal();
        actionModals.showInfoModal({
            title: '{% trans "خطأ" %}',
            message: '{% trans "فشل تحميل القطع" %}',
            type: 'error'
        });
    }
}

// عرض القطع في الجدول
function displayParts(parts) {
    const tbody = document.getElementById('partsTableBody');
    tbody.innerHTML = '';
    
    parts.forEach(part => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${part.sku}</strong></td>
            <td>${part.part.name_ar || part.part.name}</td>
            <td>${part.part.category ? part.part.category.name_ar : '-'}</td>
            <td>
                ${part.vehicle_source 
                    ? `${part.vehicle_source.make.name_ar} ${part.vehicle_source.model.name_ar}` 
                    : '-'}
            </td>
            <td><span class="badge bg-info">${part.quantity}</span></td>
            <td class="current-price"><strong>${part.selling_price} EGP</strong></td>
            <td>
                <input type="number" 
                       class="form-control form-control-sm new-price" 
                       data-part-id="${part.id}"
                       placeholder="${part.selling_price}" 
                       step="0.01">
            </td>
            <td>
                <button class="btn btn-sm btn-success"
                        onclick="updateSinglePrice(${part.id}, this)">
                    <i class="bi bi-check-circle"></i>
                    {% trans "تحديث" %}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// تحديث سعر قطعة واحدة
async function updateSinglePrice(partId, button) {
    const input = button.closest('tr').querySelector('.new-price');
    const newPrice = parseFloat(input.value);

    if (!newPrice || newPrice <= 0) {
        actionModals.showInfoModal({
            title: '{% trans "تحذير" %}',
            message: '{% trans "يرجى إدخال سعر صحيح" %}',
            type: 'warning'
        });
        return;
    }

    actionModals.showConfirmModal({
        title: '{% trans "تأكيد التحديث" %}',
        message: `{% trans "هل أنت متأكد من تحديث السعر إلى" %} ${newPrice} EGP؟`,
        confirmText: '{% trans "تحديث" %}',
        confirmClass: 'btn-success',
        icon: 'check-circle',
        onConfirm: async () => {
            const loadingModal = actionModals.showLoadingModal('{% trans "جاري تحديث السعر..." %}');

            try {
                const result = await app.apiRequest(`/api/inventory/items/${partId}/`, {
                    method: 'PATCH',
                    body: JSON.stringify({ selling_price: newPrice })
                });

                actionModals.hideLoadingModal();

                if (result) {
                    // تحديث السعر في الجدول
                    button.closest('tr').querySelector('.current-price strong').textContent = `${newPrice} EGP`;
                    input.value = '';

                    actionModals.showInfoModal({
                        title: '{% trans "نجح!" %}',
                        message: '{% trans "تم تحديث السعر بنجاح" %}',
                        type: 'success'
                    });
                }
            } catch (error) {
                actionModals.hideLoadingModal();
                actionModals.showInfoModal({
                    title: '{% trans "خطأ" %}',
                    message: '{% trans "فشل تحديث السعر" %}',
                    type: 'error'
                });
            }
        }
    });
}

// تنفيذ التحديث الجماعي
async function performBulkUpdate() {
    const updateType = document.getElementById('updateType').value;
    const percentage = parseFloat(document.getElementById('percentage').value);
    const applyTo = document.getElementById('applyTo').value;

    if (!percentage || percentage <= 0) {
        actionModals.showInfoModal({
            title: '{% trans "تحذير" %}',
            message: '{% trans "يرجى إدخال نسبة صحيحة" %}',
            type: 'warning'
        });
        return;
    }

    const message = updateType === 'increase'
        ? `{% trans "زيادة الأسعار بنسبة" %} ${percentage}%`
        : `{% trans "تخفيض الأسعار بنسبة" %} ${percentage}%`;

    actionModals.showConfirmModal({
        title: '{% trans "تأكيد التحديث الجماعي" %}',
        message: `{% trans "هل أنت متأكد من" %} ${message}؟`,
        details: '{% trans "سيتم تطبيق التحديث على جميع القطع المحددة. لا يمكن التراجع عن هذا الإجراء." %}',
        confirmText: '{% trans "تطبيق" %}',
        confirmClass: 'btn-warning',
        icon: 'exclamation-triangle',
        onConfirm: async () => {
            const loadingModal = actionModals.showLoadingModal('{% trans "جاري تطبيق التحديث الجماعي..." %}');

            try {
                // جلب جميع القطع
                const data = await app.apiRequest('/api/inventory/items/?page_size=1000');

                if (!data || !data.results) {
                    throw new Error('{% trans "فشل تحميل القطع" %}');
                }

                // تطبيق التحديث على كل قطعة
                let updatedCount = 0;
                for (const part of data.results) {
                    const currentPrice = part.selling_price;
                    let newPrice;

                    if (updateType === 'increase') {
                        newPrice = currentPrice * (1 + percentage / 100);
                    } else {
                        newPrice = currentPrice * (1 - percentage / 100);
                    }

                    newPrice = Math.round(newPrice * 100) / 100; // تقريب لرقمين عشريين

                    await app.apiRequest(`/api/inventory/items/${part.id}/`, {
                        method: 'PATCH',
                        body: JSON.stringify({ selling_price: newPrice })
                    });

                    updatedCount++;
                }

                actionModals.hideLoadingModal();

                actionModals.showInfoModal({
                    title: '{% trans "نجح! ✅" %}',
                    message: `{% trans "تم تحديث" %} ${updatedCount} {% trans "قطعة بنجاح" %}`,
                    type: 'success',
                    onClose: () => loadAllParts()
                });

            } catch (error) {
                actionModals.hideLoadingModal();
                actionModals.showInfoModal({
                    title: '{% trans "خطأ" %}',
                    message: '{% trans "فشل التحديث الجماعي" %}',
                    type: 'error'
                });
            }
        }
    });
}

// حاسبة السعر
function calculateNewPrice(type) {
    const currentPrice = parseFloat(document.getElementById('calcCurrentPrice').value);
    const percentage = parseFloat(document.getElementById('calcPercentage').value);
    
    if (!currentPrice || !percentage) {
        return;
    }
    
    let newPrice;
    if (type === 'increase') {
        newPrice = currentPrice * (1 + percentage / 100);
    } else {
        newPrice = currentPrice * (1 - percentage / 100);
    }
    
    document.getElementById('calcNewPrice').textContent = `${newPrice.toFixed(2)} EGP`;
}

// حساب سريع
function quickCalc(percentage, type) {
    document.getElementById('calcPercentage').value = percentage;
    calculateNewPrice(type);
}

// البحث في الجدول
document.getElementById('searchParts')?.addEventListener('input', function() {
    const searchValue = this.value.toLowerCase();
    const rows = document.querySelectorAll('#partsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
});
</script>
{% endblock %}
