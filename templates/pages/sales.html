{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Ø§Ù„Ø·Ù„Ø¨Ø§Øª" %} - SH Parts{% endblock %}
{% block page_title %}<span data-translate="orders">{% trans "Ø§Ù„Ø·Ù„Ø¨Ø§Øª" %}</span>{% endblock %}

{% block content %}
<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>
                <i class="bi bi-cart-check me-2"></i>
                <span>{% trans "Ø§Ù„Ø·Ù„Ø¨Ø§Øª" %}</span>
            </h2>
            <button class="btn btn-primary btn-lg" onclick="openNewOrderModal()">
                <i class="bi bi-plus-circle me-2"></i>
                {% trans "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯" %}
            </button>
        </div>
    </div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    {% trans "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="salesTable">
                        <thead>
                            <tr>
                                <th>{% trans "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨" %}</th>
                                <th>{% trans "Ø§Ù„Ø¹Ù…ÙŠÙ„" %}</th>
                                <th>{% trans "Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©" %}</th>
                                <th>{% trans "Ø§Ù„ØªØ§Ø±ÙŠØ®" %}</th>
                                <th>{% trans "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" %}</th>
                                <th>{% trans "Ø§Ù„Ø­Ø§Ù„Ø©" %}</th>
                                <th>{% trans "Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹" %}</th>
                                <th>{% trans "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if sales %}
                                {% for sale in sales %}
                                <tr>
                                    <td><strong>{{ sale.invoice_number }}</strong></td>
                                    <td>
                                        {% if sale.customer %}
                                            {{ sale.customer.first_name }} {{ sale.customer.last_name }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>-</td>
                                    <td>{{ sale.created_at|date:"Y-m-d"|default:"-" }}</td>
                                    <td><strong>{{ sale.total_amount }} EGP</strong></td>
                                    <td>
                                        {% if sale.status == 'DRAFT' %}
                                            <span class="badge bg-warning">{% trans "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" %}</span>
                                        {% elif sale.status == 'COMPLETED' %}
                                            <span class="badge bg-success">{% trans "Ù…ÙƒØªÙ…Ù„" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "Ù…Ù„ØºÙŠ" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if sale.payment_status == 'PAID' %}
                                            <span class="badge bg-success">{% trans "Ù…Ø¯ÙÙˆØ¹" %}</span>
                                        {% elif sale.payment_status == 'PARTIAL' %}
                                            <span class="badge bg-warning">{% trans "Ø¬Ø²Ø¦ÙŠ" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info" onclick="viewOrder({{ sale.id }})" data-translate-title="view_order" title="Ø¹Ø±Ø¶">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-success" onclick="printOrder({{ sale.id }})" data-translate-title="print_order" title="Ø·Ø¨Ø§Ø¹Ø©">
                                                <i class="bi bi-printer"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted" data-translate="no_orders">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
let currentOrder = {
    customer: null,
    carModel: null,
    items: []
};

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
function openNewOrderModal() {
    actionModals.showFormModal({
        title: 'âœ¨ ' + t('new_order'),
        fields: [
            {
                name: 'customer_id',
                label: t('select_customer'),
                type: 'select',
                required: true,
                options: []  // Ø³Ù†Ù…Ù„Ø£Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
            }
        ],
        submitText: t('next'),
        onSubmit: async (data) => {
            currentOrder.customer = data.customer_id;
            await showCarModelSelection();
        }
    });
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    loadCustomersForModal();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„Ù†Ø§ÙØ°Ø©
async function loadCustomersForModal() {
    try {
        const data = await app.apiRequest('/api/customers/');
        if (data && data.results) {
            const selectElement = document.querySelector('select[name="customer_id"]');
            if (selectElement) {
                data.results.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.first_name} ${customer.last_name} - ${customer.phone}`;
                    selectElement.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
async function showCarModelSelection() {
    try {
        const data = await app.apiRequest('/api/cars/models/');
        const models = data && data.results ? data.results : [];
        
        actionModals.showFormModal({
            title: 'ğŸš— ' + t('select_car_model'),
            fields: [
                {
                    name: 'car_model_id',
                    label: t('car_type'),
                    type: 'select',
                    required: true,
                    options: models.map(m => ({
                        value: m.id,
                        label: `${m.make_name_ar || m.make_name} ${m.name_ar || m.name} (${m.year_start})`
                    }))
                }
            ],
            submitText: t('show_available_parts'),
            cancelText: t('back'),
            onSubmit: async (data) => {
                currentOrder.carModel = data.car_model_id;
                await showAvailableParts();
            }
        });
    } catch (error) {
        actionModals.showInfoModal({
            title: t('error'),
            message: t('failed_to_load_car_models'),
            type: 'error'
        });
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…ØªÙˆÙØ±Ø©
async function showAvailableParts() {
    app.showLoading();

    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±
        const url = `/api/inventory/items/?vehicle_source__model=${currentOrder.carModel}&status=AVAILABLE`;
        console.log('Fetching parts from:', url);

        const data = await app.apiRequest(url);
        console.log('Parts data received:', data);

        app.hideLoading();

        if (!data || !data.results || data.results.length === 0) {
            actionModals.showInfoModal({
                title: t('no_parts_title'),
                message: t('no_parts_available'),
                type: 'warning',
                onClose: () => showCarModelSelection()
            });
            return;
        }

        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø·Ø¹
        showPartsSelectionModal(data.results);

    } catch (error) {
        console.error('Error loading parts:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: `ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…ØªÙˆÙØ±Ø©: ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
            type: 'error'
        });
    }
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø·Ø¹
function showPartsSelectionModal(parts) {
    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ù‚Ø·Ø¹
    let partsHtml = `
        <div class="mb-3">
            <h6 class="text-success">
                <i class="bi bi-check-circle me-2"></i>
                ${t('available_parts_count')}: ${parts.length}
            </h6>
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover">
                <thead class="table-light sticky-top">
                    <tr>
                        <th data-translate="part">Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                        <th data-translate="available_quantity">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</th>
                        <th data-translate="price">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th data-translate="quantity">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    parts.forEach((part, index) => {
        const partName = part.part_name_ar || part.part_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const partNameEscaped = partName.replace(/'/g, "\\'");

        partsHtml += `
            <tr>
                <td>
                    <strong>${partName}</strong><br>
                    <small class="text-muted">SKU: ${part.sku}</small>
                </td>
                <td><span class="badge bg-info">${part.quantity}</span></td>
                <td><strong class="text-success">${part.selling_price} ${'EGP'}</strong></td>
                <td>
                    <input type="number"
                           class="form-control form-control-sm"
                           id="qty_${part.id}"
                           min="1"
                           max="${part.quantity}"
                           value="1"
                           style="width: 80px;">
                </td>
                <td>
                    <button type="button"
                            class="btn btn-sm btn-primary"
                            onclick="addPartToOrder(${part.id}, '${partNameEscaped}', ${part.selling_price}, ${part.quantity})">
                        <i class="bi bi-plus-circle"></i>
                        ${t('add_to_order')}
                    </button>
                </td>
            </tr>
        `;
    });
    
    partsHtml += `
                </tbody>
            </table>
        </div>
        <div class="mt-3 p-3 bg-light rounded">
            <h6>${t('selected_parts')}: <span id="addedItemsCount">0</span></h6>
            <div id="addedItemsList"></div>
        </div>
    `;
    
    const modalHtml = `
        <div class="modal fade" id="partsSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-gear me-2"></i>
                            ${t('select_parts_for_order')}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${partsHtml}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${t('cancel')}</button>
                        <button type="button" class="btn btn-primary" onclick="finishOrder()">
                            <i class="bi bi-check-circle me-2"></i>
                            ${t('save_order')}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const container = document.getElementById('action-modal-container');
    container.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('partsSelectionModal'));
    modal.show();
}

// Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© Ù„Ù„Ø·Ù„Ø¨
function addPartToOrder(partId, partName, price, maxQty) {
    const qtyInput = document.getElementById(`qty_${partId}`);
    const quantity = parseInt(qtyInput.value) || 1;
    
    if (quantity > maxQty) {
        actionModals.showInfoModal({
            title: 'ØªØ­Ø°ÙŠØ±',
            message: `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©: ${maxQty} ÙÙ‚Ø·`,
            type: 'warning'
        });
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    const existingIndex = currentOrder.items.findIndex(item => item.partId === partId);
    if (existingIndex >= 0) {
        currentOrder.items[existingIndex].quantity += quantity;
    } else {
        currentOrder.items.push({
            partId: partId,
            partName: partName,
            price: price,
            quantity: quantity,
            total: price * quantity
        });
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    updateAddedItemsList();

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ - ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ©
function updateAddedItemsList() {
    const countEl = document.getElementById('addedItemsCount');
    const listEl = document.getElementById('addedItemsList');
    
    if (!countEl || !listEl) return;
    
    countEl.textContent = currentOrder.items.length;
    
    if (currentOrder.items.length === 0) {
        listEl.innerHTML = '<small class="text-muted">' + t('no_parts_selected') + '</small>';
        return;
    }
    
    let html = '<div class="mt-2">';
    currentOrder.items.forEach((item, index) => {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                <div>
                    <strong>${item.partName}</strong><br>
                    <small>${t('quantity')}: ${item.quantity} Ã— ${item.price} ${'EGP'}</small>
                </div>
                <div>
                    <strong class="text-success">${item.total} ${'EGP'}</strong>
                    <button class="btn btn-sm btn-danger ms-2" onclick="removeItemFromOrder(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    const total = currentOrder.items.reduce((sum, item) => sum + item.total, 0);
    html += `<div class="mt-3 p-2 bg-primary text-white rounded text-center">
        <strong>${t('total')}: ${total} ${'EGP'}</strong>
    </div>`;
    
    listEl.innerHTML = html;
}

// Ø­Ø°Ù Ù‚Ø·Ø¹Ø© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨
function removeItemFromOrder(index) {
    currentOrder.items.splice(index, 1);
    updateAddedItemsList();
}

// Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨
async function finishOrder() {
    if (currentOrder.items.length === 0) {
        actionModals.showInfoModal({
            title: t('warning'),
            message: t('please_add_one_part'),
            type: 'warning'
        });
        return;
    }

    app.showLoading(t('saving_order'));

    try {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
        const salesPersonId = parseInt(document.body.dataset.userId);
        const orderData = {
            customer: parseInt(currentOrder.customer),
            sales_person: salesPersonId,
            discount_amount: 0,
            tax_amount: 0,
            notes: '',
            items: currentOrder.items.map(item => {
                const quantity = parseInt(item.quantity);
                const unitPrice = parseFloat(item.price);
                const totalPrice = quantity * unitPrice;

                return {
                    inventory_item: parseInt(item.partId),
                    quantity: quantity,
                    unit_price: unitPrice,
                    discount_percent: 0,
                    discount_amount: 0,
                    total_price: totalPrice
                };
            })
        };

        console.log('Sending order data:', orderData);

        // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨
        const result = await app.apiRequest('/api/sales/', {
            method: 'POST',
            body: JSON.stringify(orderData)
        });

        console.log('Order created:', result);

        app.hideLoading();

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        const modal = document.getElementById('partsSelectionModal');
        if (modal) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
            setTimeout(() => modal.remove(), 300);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        currentOrder = { customer: null, carModel: null, items: [] };

        // âœ… Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹
        showPaymentModal(result);

    } catch (error) {
        console.error('Error saving order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: t('error'),
            message: `${t('order_save_failed')}: ${error.message || t('unknown_error')}`,
            type: 'error'
        });
    }
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹
function showPaymentModal(sale) {
    console.log('Payment modal - Sale data:', sale);

    const totalAmount = parseFloat(sale.total_amount || 0);
    const currencySymbol = 'EGP';

    console.log('Total amount:', totalAmount);

    if (totalAmount <= 0) {
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­',
            type: 'error'
        });
        return;
    }

    const modalHtml = `
        <div class="modal fade" id="paymentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ’³ Ø§Ù„Ø¯ÙØ¹ - ${sale.invoice_number || 'N/A'}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!
                        </div>

                        <div class="mb-3 text-center">
                            <h6 class="text-muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø¯ÙØ¹Ù‡:</h6>
                            <h2 class="text-primary fw-bold">${totalAmount.toFixed(2)} ${currencySymbol}</h2>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="paidAmount"
                                   min="0" max="${totalAmount}" step="0.01"
                                   value="${totalAmount}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ <span class="text-danger">*</span></label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="CASH">Ù†Ù‚Ø¯Ø§Ù‹</option>
                                <option value="CARD">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                                <option value="BANK_TRANSFER">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                                <option value="CHEQUE">Ø´ÙŠÙƒ</option>
                                <option value="CREDIT">Ø¢Ø¬Ù„</option>
                            </select>
                        </div>

                        <div class="mb-3" id="referenceNumberDiv" style="display: none;">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</label>
                            <input type="text" class="form-control" id="referenceNumber"
                                   placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ / Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                        </div>

                        <div id="balanceInfo" class="alert alert-info" style="display: none;">
                            <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> <span id="balanceAmount">0.00</span> ${currencySymbol}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            ØªØ®Ø·ÙŠ Ø§Ù„Ø¯ÙØ¹
                        </button>
                        <button type="button" class="btn btn-success" onclick="processPayment(${sale.id}, ${totalAmount})">
                            <i class="bi bi-check-circle me-2"></i>
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„ØµÙØ­Ø©
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    document.getElementById('paymentModal').addEventListener('hidden.bs.modal', function() {
        modalContainer.remove();
        location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    });

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
    document.getElementById('paidAmount').addEventListener('input', function() {
        const paid = parseFloat(this.value) || 0;
        const balance = totalAmount - paid;
        const balanceInfo = document.getElementById('balanceInfo');
        const balanceAmount = document.getElementById('balanceAmount');

        if (balance > 0) {
            balanceInfo.style.display = 'block';
            balanceAmount.textContent = balance.toFixed(2);
        } else {
            balanceInfo.style.display = 'none';
        }
    });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø·Ø±Ù‚ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡
    document.getElementById('paymentMethod').addEventListener('change', function() {
        const refDiv = document.getElementById('referenceNumberDiv');
        if (['CARD', 'BANK_TRANSFER', 'CHEQUE'].includes(this.value)) {
            refDiv.style.display = 'block';
        } else {
            refDiv.style.display = 'none';
        }
    });
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹
async function processPayment(saleId, totalAmount) {
    const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const referenceNumber = document.getElementById('referenceNumber').value;
    const notes = document.getElementById('paymentNotes').value;

    if (paidAmount <= 0) {
        actionModals.showInfoModal({
            title: 'ØªØ­Ø°ÙŠØ±',
            message: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­',
            type: 'warning'
        });
        return;
    }

    if (paidAmount > totalAmount) {
        actionModals.showInfoModal({
            title: 'ØªØ­Ø°ÙŠØ±',
            message: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
            type: 'warning'
        });
        return;
    }

    app.showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹...');

    try {
        const paymentData = {
            amount: paidAmount,
            payment_method: paymentMethod,
            reference_number: referenceNumber,
            notes: notes
        };

        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… endpoint Ø§Ù„ØµØ­ÙŠØ­: /api/sales/{id}/add_payment/
        const result = await app.apiRequest(`/api/sales/${saleId}/add_payment/`, {
            method: 'POST',
            body: JSON.stringify(paymentData)
        });

        app.hideLoading();

        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹
        const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
        modal.hide();

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        actionModals.showInfoModal({
            title: 'ØªÙ… Ø§Ù„Ø¯ÙØ¹! âœ…',
            message: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­\nØ±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹: ${result.payment_number || 'N/A'}\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${paidAmount.toFixed(2)} ${'EGP'}`,
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error processing payment:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: `ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹: ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
            type: 'error'
        });
    }
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨
async function viewOrder(id) {
    app.showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨...');

    try {
        const sale = await app.apiRequest(`/api/sales/${id}/`);
        console.log('Sale details:', sale);

        app.hideLoading();

        // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
        let itemsHtml = '';
        let subtotal = 0;

        if (sale.items && sale.items.length > 0) {
            sale.items.forEach(item => {
                const itemTotal = parseFloat(item.total_price);
                subtotal += itemTotal;
                itemsHtml += `
                    <tr>
                        <td>${item.part_name || item.inventory_item_details?.part?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-end">${parseFloat(item.unit_price).toFixed(2)}</td>
                        <td class="text-end"><strong>${itemTotal.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
        }

        const currencySymbol = 'EGP';

        const modalHtml = `
            <div class="modal fade" id="viewOrderModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-receipt me-2"></i>
                                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ - ${sale.invoice_number}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h6>
                                    <p class="mb-1"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${sale.customer_details?.first_name || ''} ${sale.customer_details?.last_name || ''}</p>
                                    <p class="mb-1"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${sale.customer_details?.phone || '-'}</p>
                                    <p class="mb-1"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${sale.customer_details?.address || '-'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h6>
                                    <p class="mb-1"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(sale.created_at).toLocaleDateString('ar-EG')}</p>
                                    <p class="mb-1"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge bg-${sale.status === 'COMPLETED' ? 'success' : sale.status === 'DRAFT' ? 'warning' : 'secondary'}">${sale.status_display}</span></p>
                                    <p class="mb-1"><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</strong> <span class="badge bg-${sale.payment_status === 'PAID' ? 'success' : sale.payment_status === 'PARTIAL' ? 'warning' : 'danger'}">${sale.payment_status_display}</span></p>
                                    <p class="mb-1"><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${sale.sales_person_name || '-'}</p>
                                </div>
                            </div>

                            <h6 class="text-muted mb-3">Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                                            <th class="text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                            <th class="text-end">Ø§Ù„Ø³Ø¹Ø±</th>
                                            <th class="text-end">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${itemsHtml}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong></td>
                                            <td class="text-end"><strong>${parseFloat(sale.subtotal).toFixed(2)} ${currencySymbol}</strong></td>
                                        </tr>
                                        ${sale.discount_amount > 0 ? `
                                        <tr>
                                            <td colspan="3" class="text-end">Ø§Ù„Ø®ØµÙ…:</td>
                                            <td class="text-end text-danger">-${parseFloat(sale.discount_amount).toFixed(2)} ${currencySymbol}</td>
                                        </tr>
                                        ` : ''}
                                        ${sale.tax_amount > 0 ? `
                                        <tr>
                                            <td colspan="3" class="text-end">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</td>
                                            <td class="text-end">+${parseFloat(sale.tax_amount).toFixed(2)} ${currencySymbol}</td>
                                        </tr>
                                        ` : ''}
                                        <tr class="table-primary">
                                            <td colspan="3" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</strong></td>
                                            <td class="text-end"><strong>${parseFloat(sale.total_amount).toFixed(2)} ${currencySymbol}</strong></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td colspan="3" class="text-end">Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</td>
                                            <td class="text-end">${parseFloat(sale.paid_amount).toFixed(2)} ${currencySymbol}</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td colspan="3" class="text-end"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong></td>
                                            <td class="text-end"><strong>${parseFloat(sale.balance_due).toFixed(2)} ${currencySymbol}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            ${sale.notes ? `
                            <div class="mt-3">
                                <h6 class="text-muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h6>
                                <p class="border p-2 rounded">${sale.notes}</p>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                            <button type="button" class="btn btn-success" onclick="printOrder(${id})">
                                <i class="bi bi-printer me-2"></i>
                                Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                            </button>
                            ${sale.status === 'DRAFT' || sale.status === 'CONFIRMED' ? `
                            <button type="button" class="btn btn-primary" onclick="completeOrder(${id})">
                                <i class="bi bi-check-circle me-2"></i>
                                Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
                            </button>
                            <button type="button" class="btn btn-danger" onclick="cancelOrder(${id})">
                                <i class="bi bi-x-circle me-2"></i>
                                Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Ø¥Ø¶Ø§ÙØ© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
        const container = document.getElementById('action-modal-container');
        container.insertAdjacentHTML('beforeend', modalHtml);

        const modal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
        modal.show();

        // Ø­Ø°Ù Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        document.getElementById('viewOrderModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });

    } catch (error) {
        console.error('Error loading order details:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: `ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨: ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
            type: 'error'
        });
    }
}

// Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
async function completeOrder(id) {
    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹
    app.showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨...');

    try {
        const sale = await app.apiRequest(`/api/sales/${id}/`);
        app.hideLoading();

        const totalAmount = parseFloat(sale.total_amount || 0);
        const paidAmount = parseFloat(sale.paid_amount || 0);
        const balanceDue = parseFloat(sale.balance_due || 0);
        const paymentStatus = sale.payment_status;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø£Ùˆ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹ØŒ Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹
        if (paymentStatus !== 'PAID' && balanceDue > 0) {
            const shouldPay = await actionModals.showConfirmModal({
                title: 'âš ï¸ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
                message: `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAmount.toFixed(2)} ${'EGP'}\nØ§Ù„Ù…Ø¯ÙÙˆØ¹: ${paidAmount.toFixed(2)} ${'EGP'}\nØ§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${balanceDue.toFixed(2)} ${'EGP'}\n\nÙŠØ¬Ø¨ Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù‚Ø¨Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø§Ù„Ø¢Ù†ØŸ`,
                confirmText: 'Ù†Ø¹Ù…ØŒ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©',
                cancelText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (!shouldPay) return;

            // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            showPaymentModalForCompletion(sale, balanceDue);
            return;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙÙˆØ¹Ø§Ù‹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØªÙ…Ø§Ù…
        const confirmed = await actionModals.showConfirmModal({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨',
            message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØªÙ…Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.',
            confirmText: 'Ù†Ø¹Ù…ØŒ Ø¥ØªÙ…Ø§Ù…',
            cancelText: 'Ø¥Ù„ØºØ§Ø¡'
        });

        if (!confirmed) return;

        app.showLoading('Ø¬Ø§Ø±ÙŠ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨...');

        const result = await app.apiRequest(`/api/sales/${id}/complete/`, {
            method: 'POST'
        });

        app.hideLoading();

        actionModals.showInfoModal({
            title: 'ØªÙ… Ø§Ù„Ø¥ØªÙ…Ø§Ù…! âœ…',
            message: 'ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error completing order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: `ÙØ´Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨: ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
            type: 'error'
        });
    }
}

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹
function showPaymentModalForCompletion(sale, requiredAmount) {
    const currencySymbol = 'EGP';

    const modalHtml = `
        <div class="modal fade" id="completionPaymentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">âš ï¸ Ø¯ÙØ¹ Ù…Ø·Ù„ÙˆØ¨ - ${sale.invoice_number}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            ÙŠØ¬Ø¨ Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù‚Ø¨Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
                        </div>

                        <div class="mb-3">
                            <h6>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</h6>
                            <h4 class="text-primary">${parseFloat(sale.total_amount).toFixed(2)} ${currencySymbol}</h4>
                        </div>

                        <div class="mb-3">
                            <h6>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø³Ø§Ø¨Ù‚Ø§Ù‹:</h6>
                            <h5 class="text-success">${parseFloat(sale.paid_amount || 0).toFixed(2)} ${currencySymbol}</h5>
                        </div>

                        <div class="mb-3">
                            <h6>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</h6>
                            <h3 class="text-danger">${requiredAmount.toFixed(2)} ${currencySymbol}</h3>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="completionPaidAmount"
                                   min="${requiredAmount}" max="${requiredAmount}" step="0.01"
                                   value="${requiredAmount}" required>
                            <small class="text-muted">ÙŠØ¬Ø¨ Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ <span class="text-danger">*</span></label>
                            <select class="form-select" id="completionPaymentMethod" required>
                                <option value="CASH">Ù†Ù‚Ø¯Ø§Ù‹</option>
                                <option value="CARD">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                                <option value="BANK_TRANSFER">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                                <option value="CHEQUE">Ø´ÙŠÙƒ</option>
                            </select>
                        </div>

                        <div class="mb-3" id="completionReferenceNumberDiv" style="display: none;">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</label>
                            <input type="text" class="form-control" id="completionReferenceNumber"
                                   placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ / Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea class="form-control" id="completionPaymentNotes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                        <button type="button" class="btn btn-success" onclick="processCompletionPayment(${sale.id}, ${requiredAmount})">
                            <i class="bi bi-check-circle me-2"></i>
                            Ø¯ÙØ¹ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„ØµÙØ­Ø©
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modal = new bootstrap.Modal(document.getElementById('completionPaymentModal'));
    modal.show();

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    document.getElementById('completionPaymentModal').addEventListener('hidden.bs.modal', function() {
        modalContainer.remove();
    });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø·Ø±Ù‚ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡
    document.getElementById('completionPaymentMethod').addEventListener('change', function() {
        const refDiv = document.getElementById('completionReferenceNumberDiv');
        if (['CARD', 'BANK_TRANSFER', 'CHEQUE'].includes(this.value)) {
            refDiv.style.display = 'block';
        } else {
            refDiv.style.display = 'none';
        }
    });
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
async function processCompletionPayment(saleId, requiredAmount) {
    const paidAmount = parseFloat(document.getElementById('completionPaidAmount').value) || 0;
    const paymentMethod = document.getElementById('completionPaymentMethod').value;
    const referenceNumber = document.getElementById('completionReferenceNumber').value;
    const notes = document.getElementById('completionPaymentNotes').value;

    if (paidAmount < requiredAmount) {
        actionModals.showInfoModal({
            title: 'ØªØ­Ø°ÙŠØ±',
            message: `ÙŠØ¬Ø¨ Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (${requiredAmount.toFixed(2)} ${'EGP'})`,
            type: 'warning'
        });
        return;
    }

    app.showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨...');

    try {
        // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©
        const paymentData = {
            amount: paidAmount,
            payment_method: paymentMethod,
            reference_number: referenceNumber,
            notes: notes
        };

        await app.apiRequest(`/api/sales/${saleId}/add_payment/`, {
            method: 'POST',
            body: JSON.stringify(paymentData)
        });

        // 2. Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
        await app.apiRequest(`/api/sales/${saleId}/complete/`, {
            method: 'POST'
        });

        app.hideLoading();

        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹
        const modal = bootstrap.Modal.getInstance(document.getElementById('completionPaymentModal'));
        modal.hide();

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        actionModals.showInfoModal({
            title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! âœ…',
            message: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${paidAmount.toFixed(2)} ${'EGP'}`,
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error processing completion payment:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: `ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹: ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
            type: 'error'
        });
    }
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
async function cancelOrder(id) {
    const confirmed = await actionModals.showConfirmModal({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨',
        message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¬Ø² Ø§Ù„Ù‚Ø·Ø¹ ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†.',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨',
        cancelText: 'Ø±Ø¬ÙˆØ¹'
    });

    if (!confirmed) return;

    app.showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨...');

    try {
        const result = await app.apiRequest(`/api/sales/${id}/cancel/`, {
            method: 'POST'
        });

        app.hideLoading();

        actionModals.showInfoModal({
            title: 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ âœ…',
            message: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø·Ø¹ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†',
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error cancelling order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: `ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨: ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
            type: 'error'
        });
    }
}

// Ø·Ø¨Ø§Ø¹Ø© Ø·Ù„Ø¨
async function printOrder(id) {
    app.showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©...');

    try {
        const sale = await app.apiRequest(`/api/sales/${id}/`);

        app.hideLoading();

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        const printWindow = window.open('', '_blank', 'width=800,height=600');

        let itemsHtml = '';
        let subtotal = 0;

        if (sale.items && sale.items.length > 0) {
            sale.items.forEach((item, index) => {
                const itemTotal = parseFloat(item.total_price);
                subtotal += itemTotal;
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.part_name || item.inventory_item_details?.part?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-end">${parseFloat(item.unit_price).toFixed(2)}</td>
                        <td class="text-end"><strong>${itemTotal.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
        }

        const currencySymbol = 'EGP';
        const currentDate = new Date().toLocaleDateString('ar-EG');

        const printContent = `
            <!DOCTYPE html>
            <html dir="rtl" lang="ar">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>ÙØ§ØªÙˆØ±Ø© - ${sale.invoice_number}</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        padding: 20px;
                        direction: rtl;
                    }
                    .invoice-header {
                        text-align: center;
                        margin-bottom: 30px;
                        border-bottom: 3px solid #333;
                        padding-bottom: 20px;
                    }
                    .invoice-header h1 {
                        color: #2c3e50;
                        margin-bottom: 10px;
                    }
                    .invoice-header p {
                        color: #7f8c8d;
                        font-size: 14px;
                    }
                    .invoice-info {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 30px;
                    }
                    .info-section {
                        flex: 1;
                    }
                    .info-section h3 {
                        color: #2c3e50;
                        margin-bottom: 10px;
                        font-size: 16px;
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 5px;
                    }
                    .info-section p {
                        margin: 5px 0;
                        font-size: 14px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                    }
                    th, td {
                        border: 1px solid #ddd;
                        padding: 12px;
                        text-align: right;
                    }
                    th {
                        background-color: #3498db;
                        color: white;
                        font-weight: bold;
                    }
                    .text-center {
                        text-align: center;
                    }
                    .text-end {
                        text-align: left;
                    }
                    .totals {
                        margin-top: 20px;
                        float: left;
                        width: 300px;
                    }
                    .totals table {
                        margin-bottom: 0;
                    }
                    .totals td {
                        padding: 8px;
                    }
                    .total-row {
                        background-color: #ecf0f1;
                        font-weight: bold;
                        font-size: 16px;
                    }
                    .section-title {
                        margin-bottom: 15px;
                        color: #2c3e50;
                    }
                    .row-discount {
                        color: #e74c3c;
                        font-weight: 600;
                    }
                    .row-paid {
                        background-color: #d5f4e6;
                    }
                    .row-remaining {
                        background-color: #fff3cd;
                    }
                    .footer {
                        clear: both;
                        margin-top: 50px;
                        text-align: center;
                        padding-top: 20px;
                        border-top: 2px solid #333;
                        color: #7f8c8d;
                        font-size: 12px;
                    }
                    .badge {
                        display: inline-block;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: bold;
                    }
                    .badge-success {
                        background-color: #27ae60;
                        color: white;
                    }
                    .badge-warning {
                        background-color: #f39c12;
                        color: white;
                    }
                    .badge-danger {
                        background-color: #e74c3c;
                        color: white;
                    }
                    @media print {
                        body {
                            padding: 0;
                        }
                        .no-print {
                            display: none;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-header">
                    <h1>ğŸš— SH Parts - ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
                    <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</p>
                </div>

                <div class="invoice-info">
                    <div class="info-section">
                        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${sale.invoice_number}</p>
                        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(sale.created_at).toLocaleDateString('ar-EG')}</p>
                        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge badge-${sale.status === 'COMPLETED' ? 'success' : sale.status === 'DRAFT' ? 'warning' : 'secondary'}">${sale.status_display}</span></p>
                        <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</strong> <span class="badge badge-${sale.payment_status === 'PAID' ? 'success' : sale.payment_status === 'PARTIAL' ? 'warning' : 'danger'}">${sale.payment_status_display}</span></p>
                    </div>

                    <div class="info-section">
                        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${sale.customer_details?.first_name || ''} ${sale.customer_details?.last_name || ''}</p>
                        <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${sale.customer_details?.phone || '-'}</p>
                        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${sale.customer_details?.address || '-'}</p>
                        <p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${sale.sales_person_name || '-'}</p>
                    </div>
                </div>

                <h3 class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹</h3>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                            <th class="text-center" style="width: 100px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th class="text-end" style="width: 120px;">Ø§Ù„Ø³Ø¹Ø±</th>
                            <th class="text-end" style="width: 120px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <div class="totals">
                    <table>
                        <tr>
                            <td><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong></td>
                            <td class="text-end"><strong>${parseFloat(sale.subtotal).toFixed(2)} ${currencySymbol}</strong></td>
                        </tr>
                        ${sale.discount_amount > 0 ? `
                        <tr>
                            <td>Ø§Ù„Ø®ØµÙ…:</td>
                            <td class="text-end row-discount">-${parseFloat(sale.discount_amount).toFixed(2)} ${currencySymbol}</td>
                        </tr>
                        ` : ''}
                        ${sale.tax_amount > 0 ? `
                        <tr>
                            <td>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</td>
                            <td class="text-end">+${parseFloat(sale.tax_amount).toFixed(2)} ${currencySymbol}</td>
                        </tr>
                        ` : ''}
                        <tr class="total-row">
                            <td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</strong></td>
                            <td class="text-end"><strong>${parseFloat(sale.total_amount).toFixed(2)} ${currencySymbol}</strong></td>
                        </tr>
                        <tr class="row-paid">
                            <td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</td>
                            <td class="text-end">${parseFloat(sale.paid_amount).toFixed(2)} ${currencySymbol}</td>
                        </tr>
                        <tr class="row-remaining">
                            <td><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong></td>
                            <td class="text-end"><strong>${parseFloat(sale.balance_due).toFixed(2)} ${currencySymbol}</strong></td>
                        </tr>
                    </table>
                </div>

                <div class="footer">
                    <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p>
                    <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${currentDate}</p>
                    <p>SH Parts - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</p>
                </div>

                <div class="no-print" style="text-align: center; margin-top: 30px;">
                    <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button onclick="window.close()" style="padding: 10px 30px; font-size: 16px; background-color: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </body>
            </html>
        `;

        printWindow.document.write(printContent);
        printWindow.document.close();

        // Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.print();
            }, 250);
        };

    } catch (error) {
        console.error('Error printing order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'Ø®Ø·Ø£',
            message: `ÙØ´Ù„ ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: ${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
            type: 'error'
        });
    }
}
</script>
{% endblock %}
