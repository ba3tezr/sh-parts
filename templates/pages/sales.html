{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}{% trans "الطلبات" %} - SH Parts{% endblock %}
{% block page_title %}<span data-translate="orders">{% trans "الطلبات" %}</span>{% endblock %}

{% block content %}
<!-- أزرار الإجراءات -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>
                <i class="bi bi-cart-check me-2"></i>
                <span>{% trans "الطلبات" %}</span>
            </h2>
            <button class="btn btn-primary btn-lg" onclick="openNewOrderModal()">
                <i class="bi bi-plus-circle me-2"></i>
                {% trans "طلب جديد" %}
            </button>
        </div>
    </div>
</div>

<!-- جدول الطلبات -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    {% trans "قائمة الطلبات" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="salesTable">
                        <thead>
                            <tr>
                                <th>{% trans "رقم الطلب" %}</th>
                                <th>{% trans "العميل" %}</th>
                                <th>{% trans "نوع السيارة" %}</th>
                                <th>{% trans "التاريخ" %}</th>
                                <th>{% trans "الإجمالي" %}</th>
                                <th>{% trans "الحالة" %}</th>
                                <th>{% trans "حالة الدفع" %}</th>
                                <th>{% trans "الإجراءات" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if sales %}
                                {% for sale in sales %}
                                <tr>
                                    <td><strong>{{ sale.invoice_number }}</strong></td>
                                    <td>
                                        {% if sale.customer %}
                                            {{ sale.customer.first_name }} {{ sale.customer.last_name }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>-</td>
                                    <td>{{ sale.created_at|date:"Y-m-d"|default:"-" }}</td>
                                    <td><strong>{{ sale.total_amount }} EGP</strong></td>
                                    <td>
                                        {% if sale.status == 'DRAFT' %}
                                            <span class="badge bg-warning">{% trans "قيد الانتظار" %}</span>
                                        {% elif sale.status == 'COMPLETED' %}
                                            <span class="badge bg-success">{% trans "مكتمل" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "ملغي" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if sale.payment_status == 'PAID' %}
                                            <span class="badge bg-success">{% trans "مدفوع" %}</span>
                                        {% elif sale.payment_status == 'PARTIAL' %}
                                            <span class="badge bg-warning">{% trans "جزئي" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "غير مدفوع" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info" onclick="viewOrder({{ sale.id }})" data-translate-title="view_order" title="عرض">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-success" onclick="printOrder({{ sale.id }})" data-translate-title="print_order" title="طباعة">
                                                <i class="bi bi-printer"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted" data-translate="no_orders">لا توجد طلبات بعد</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// بيانات الطلب
let currentOrder = {
    customer: null,
    carModel: null,
    items: []
};

// فتح نافذة طلب جديد
function openNewOrderModal() {
    actionModals.showFormModal({
        title: '✨ ' + t('new_order'),
        fields: [
            {
                name: 'customer_id',
                label: t('select_customer'),
                type: 'select',
                required: true,
                options: []  // سنملأها ديناميكياً
            }
        ],
        submitText: t('next'),
        onSubmit: async (data) => {
            currentOrder.customer = data.customer_id;
            await showCarModelSelection();
        }
    });
    
    // تحميل العملاء
    loadCustomersForModal();
}

// تحميل العملاء للنافذة
async function loadCustomersForModal() {
    try {
        const data = await app.apiRequest('/api/customers/');
        if (data && data.results) {
            const selectElement = document.querySelector('select[name="customer_id"]');
            if (selectElement) {
                data.results.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.first_name} ${customer.last_name} - ${customer.phone}`;
                    selectElement.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// عرض اختيار نوع السيارة
async function showCarModelSelection() {
    try {
        const data = await app.apiRequest('/api/cars/models/');
        const models = data && data.results ? data.results : [];
        
        actionModals.showFormModal({
            title: '🚗 ' + t('select_car_model'),
            fields: [
                {
                    name: 'car_model_id',
                    label: t('car_type'),
                    type: 'select',
                    required: true,
                    options: models.map(m => ({
                        value: m.id,
                        label: `${m.make_name_ar || m.make_name} ${m.name_ar || m.name} (${m.year_start})`
                    }))
                }
            ],
            submitText: t('show_available_parts'),
            cancelText: t('back'),
            onSubmit: async (data) => {
                currentOrder.carModel = data.car_model_id;
                await showAvailableParts();
            }
        });
    } catch (error) {
        actionModals.showInfoModal({
            title: t('error'),
            message: t('failed_to_load_car_models'),
            type: 'error'
        });
    }
}

// عرض القطع المتوفرة
async function showAvailableParts() {
    app.showLoading();

    try {
        // جلب القطع الخاصة بنوع السيارة المختار
        const url = `/api/inventory/items/?vehicle_source__model=${currentOrder.carModel}&status=AVAILABLE`;
        console.log('Fetching parts from:', url);

        const data = await app.apiRequest(url);
        console.log('Parts data received:', data);

        app.hideLoading();

        if (!data || !data.results || data.results.length === 0) {
            actionModals.showInfoModal({
                title: t('no_parts_title'),
                message: t('no_parts_available'),
                type: 'warning',
                onClose: () => showCarModelSelection()
            });
            return;
        }

        // عرض نافذة اختيار القطع
        showPartsSelectionModal(data.results);

    } catch (error) {
        console.error('Error loading parts:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'خطأ',
            message: `فشل تحميل القطع المتوفرة: ${error.message || 'خطأ غير معروف'}`,
            type: 'error'
        });
    }
}

// عرض نافذة اختيار القطع
function showPartsSelectionModal(parts) {
    // إنشاء HTML للقطع
    let partsHtml = `
        <div class="mb-3">
            <h6 class="text-success">
                <i class="bi bi-check-circle me-2"></i>
                ${t('available_parts_count')}: ${parts.length}
            </h6>
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover">
                <thead class="table-light sticky-top">
                    <tr>
                        <th data-translate="part">القطعة</th>
                        <th data-translate="available_quantity">الكمية المتوفرة</th>
                        <th data-translate="price">السعر</th>
                        <th data-translate="quantity">الكمية</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    parts.forEach((part, index) => {
        const partName = part.part_name_ar || part.part_name || 'غير معروف';
        const partNameEscaped = partName.replace(/'/g, "\\'");

        partsHtml += `
            <tr>
                <td>
                    <strong>${partName}</strong><br>
                    <small class="text-muted">SKU: ${part.sku}</small>
                </td>
                <td><span class="badge bg-info">${part.quantity}</span></td>
                <td><strong class="text-success">${part.selling_price} ${'EGP'}</strong></td>
                <td>
                    <input type="number"
                           class="form-control form-control-sm"
                           id="qty_${part.id}"
                           min="1"
                           max="${part.quantity}"
                           value="1"
                           style="width: 80px;">
                </td>
                <td>
                    <button type="button"
                            class="btn btn-sm btn-primary"
                            onclick="addPartToOrder(${part.id}, '${partNameEscaped}', ${part.selling_price}, ${part.quantity})">
                        <i class="bi bi-plus-circle"></i>
                        ${t('add_to_order')}
                    </button>
                </td>
            </tr>
        `;
    });
    
    partsHtml += `
                </tbody>
            </table>
        </div>
        <div class="mt-3 p-3 bg-light rounded">
            <h6>${t('selected_parts')}: <span id="addedItemsCount">0</span></h6>
            <div id="addedItemsList"></div>
        </div>
    `;
    
    const modalHtml = `
        <div class="modal fade" id="partsSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-gear me-2"></i>
                            ${t('select_parts_for_order')}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${partsHtml}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${t('cancel')}</button>
                        <button type="button" class="btn btn-primary" onclick="finishOrder()">
                            <i class="bi bi-check-circle me-2"></i>
                            ${t('save_order')}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // إضافة وعرض النافذة
    const container = document.getElementById('action-modal-container');
    container.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('partsSelectionModal'));
    modal.show();
}

// إضافة قطعة للطلب
function addPartToOrder(partId, partName, price, maxQty) {
    const qtyInput = document.getElementById(`qty_${partId}`);
    const quantity = parseInt(qtyInput.value) || 1;
    
    if (quantity > maxQty) {
        actionModals.showInfoModal({
            title: 'تحذير',
            message: `الكمية المتوفرة: ${maxQty} فقط`,
            type: 'warning'
        });
        return;
    }
    
    // التحقق من عدم الإضافة المكررة
    const existingIndex = currentOrder.items.findIndex(item => item.partId === partId);
    if (existingIndex >= 0) {
        currentOrder.items[existingIndex].quantity += quantity;
    } else {
        currentOrder.items.push({
            partId: partId,
            partName: partName,
            price: price,
            quantity: quantity,
            total: price * quantity
        });
    }
    
    // تحديث العرض
    updateAddedItemsList();

    // إزالة رسالة التأكيد - تم الإضافة بنجاح بدون رسالة منبثقة
}

// تحديث قائمة القطع المضافة
function updateAddedItemsList() {
    const countEl = document.getElementById('addedItemsCount');
    const listEl = document.getElementById('addedItemsList');
    
    if (!countEl || !listEl) return;
    
    countEl.textContent = currentOrder.items.length;
    
    if (currentOrder.items.length === 0) {
        listEl.innerHTML = '<small class="text-muted">' + t('no_parts_selected') + '</small>';
        return;
    }
    
    let html = '<div class="mt-2">';
    currentOrder.items.forEach((item, index) => {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded">
                <div>
                    <strong>${item.partName}</strong><br>
                    <small>${t('quantity')}: ${item.quantity} × ${item.price} ${'EGP'}</small>
                </div>
                <div>
                    <strong class="text-success">${item.total} ${'EGP'}</strong>
                    <button class="btn btn-sm btn-danger ms-2" onclick="removeItemFromOrder(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    const total = currentOrder.items.reduce((sum, item) => sum + item.total, 0);
    html += `<div class="mt-3 p-2 bg-primary text-white rounded text-center">
        <strong>${t('total')}: ${total} ${'EGP'}</strong>
    </div>`;
    
    listEl.innerHTML = html;
}

// حذف قطعة من الطلب
function removeItemFromOrder(index) {
    currentOrder.items.splice(index, 1);
    updateAddedItemsList();
}

// إنهاء وحفظ الطلب
async function finishOrder() {
    if (currentOrder.items.length === 0) {
        actionModals.showInfoModal({
            title: t('warning'),
            message: t('please_add_one_part'),
            type: 'warning'
        });
        return;
    }

    app.showLoading(t('saving_order'));

    try {
        // إعداد بيانات الطلب
        const salesPersonId = parseInt(document.body.dataset.userId);
        const orderData = {
            customer: parseInt(currentOrder.customer),
            sales_person: salesPersonId,
            discount_amount: 0,
            tax_amount: 0,
            notes: '',
            items: currentOrder.items.map(item => {
                const quantity = parseInt(item.quantity);
                const unitPrice = parseFloat(item.price);
                const totalPrice = quantity * unitPrice;

                return {
                    inventory_item: parseInt(item.partId),
                    quantity: quantity,
                    unit_price: unitPrice,
                    discount_percent: 0,
                    discount_amount: 0,
                    total_price: totalPrice
                };
            })
        };

        console.log('Sending order data:', orderData);

        // حفظ الطلب
        const result = await app.apiRequest('/api/sales/', {
            method: 'POST',
            body: JSON.stringify(orderData)
        });

        console.log('Order created:', result);

        app.hideLoading();

        // إغلاق النافذة
        const modal = document.getElementById('partsSelectionModal');
        if (modal) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
            setTimeout(() => modal.remove(), 300);
        }

        // إعادة تعيين البيانات
        currentOrder = { customer: null, carModel: null, items: [] };

        // ✅ عرض نافذة الدفع
        showPaymentModal(result);

    } catch (error) {
        console.error('Error saving order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: t('error'),
            message: `${t('order_save_failed')}: ${error.message || t('unknown_error')}`,
            type: 'error'
        });
    }
}

// عرض نافذة الدفع
function showPaymentModal(sale) {
    console.log('Payment modal - Sale data:', sale);

    const totalAmount = parseFloat(sale.total_amount || 0);
    const currencySymbol = 'EGP';

    console.log('Total amount:', totalAmount);

    if (totalAmount <= 0) {
        actionModals.showInfoModal({
            title: 'خطأ',
            message: 'لا يمكن عرض نافذة الدفع: المبلغ الإجمالي غير صحيح',
            type: 'error'
        });
        return;
    }

    const modalHtml = `
        <div class="modal fade" id="paymentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">💳 الدفع - ${sale.invoice_number || 'N/A'}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            تم إنشاء الطلب بنجاح!
                        </div>

                        <div class="mb-3 text-center">
                            <h6 class="text-muted">المبلغ الإجمالي الواجب دفعه:</h6>
                            <h2 class="text-primary fw-bold">${totalAmount.toFixed(2)} ${currencySymbol}</h2>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">المبلغ المدفوع <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="paidAmount"
                                   min="0" max="${totalAmount}" step="0.01"
                                   value="${totalAmount}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">طريقة الدفع <span class="text-danger">*</span></label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="CASH">نقداً</option>
                                <option value="CARD">بطاقة ائتمان</option>
                                <option value="BANK_TRANSFER">تحويل بنكي</option>
                                <option value="CHEQUE">شيك</option>
                                <option value="CREDIT">آجل</option>
                            </select>
                        </div>

                        <div class="mb-3" id="referenceNumberDiv" style="display: none;">
                            <label class="form-label">رقم المرجع</label>
                            <input type="text" class="form-control" id="referenceNumber"
                                   placeholder="رقم الشيك / رقم التحويل">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                        </div>

                        <div id="balanceInfo" class="alert alert-info" style="display: none;">
                            <strong>المتبقي:</strong> <span id="balanceAmount">0.00</span> ${currencySymbol}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            تخطي الدفع
                        </button>
                        <button type="button" class="btn btn-success" onclick="processPayment(${sale.id}, ${totalAmount})">
                            <i class="bi bi-check-circle me-2"></i>
                            تأكيد الدفع
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // إضافة النافذة للصفحة
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    // عرض النافذة
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();

    // إزالة النافذة عند الإغلاق
    document.getElementById('paymentModal').addEventListener('hidden.bs.modal', function() {
        modalContainer.remove();
        location.reload(); // إعادة تحميل الصفحة
    });

    // حساب المتبقي عند تغيير المبلغ المدفوع
    document.getElementById('paidAmount').addEventListener('input', function() {
        const paid = parseFloat(this.value) || 0;
        const balance = totalAmount - paid;
        const balanceInfo = document.getElementById('balanceInfo');
        const balanceAmount = document.getElementById('balanceAmount');

        if (balance > 0) {
            balanceInfo.style.display = 'block';
            balanceAmount.textContent = balance.toFixed(2);
        } else {
            balanceInfo.style.display = 'none';
        }
    });

    // إظهار حقل رقم المرجع للطرق التي تحتاجه
    document.getElementById('paymentMethod').addEventListener('change', function() {
        const refDiv = document.getElementById('referenceNumberDiv');
        if (['CARD', 'BANK_TRANSFER', 'CHEQUE'].includes(this.value)) {
            refDiv.style.display = 'block';
        } else {
            refDiv.style.display = 'none';
        }
    });
}

// معالجة الدفع
async function processPayment(saleId, totalAmount) {
    const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const referenceNumber = document.getElementById('referenceNumber').value;
    const notes = document.getElementById('paymentNotes').value;

    if (paidAmount <= 0) {
        actionModals.showInfoModal({
            title: 'تحذير',
            message: 'يرجى إدخال مبلغ صحيح',
            type: 'warning'
        });
        return;
    }

    if (paidAmount > totalAmount) {
        actionModals.showInfoModal({
            title: 'تحذير',
            message: 'المبلغ المدفوع أكبر من المبلغ الإجمالي',
            type: 'warning'
        });
        return;
    }

    app.showLoading('جاري معالجة الدفع...');

    try {
        const paymentData = {
            amount: paidAmount,
            payment_method: paymentMethod,
            reference_number: referenceNumber,
            notes: notes
        };

        // ✅ استخدام endpoint الصحيح: /api/sales/{id}/add_payment/
        const result = await app.apiRequest(`/api/sales/${saleId}/add_payment/`, {
            method: 'POST',
            body: JSON.stringify(paymentData)
        });

        app.hideLoading();

        // إغلاق نافذة الدفع
        const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
        modal.hide();

        // عرض رسالة نجاح
        actionModals.showInfoModal({
            title: 'تم الدفع! ✅',
            message: `تم تسجيل الدفع بنجاح\nرقم الدفع: ${result.payment_number || 'N/A'}\nالمبلغ المدفوع: ${paidAmount.toFixed(2)} ${'EGP'}`,
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error processing payment:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'خطأ',
            message: `فشل معالجة الدفع: ${error.message || 'خطأ غير معروف'}`,
            type: 'error'
        });
    }
}

// عرض تفاصيل طلب
async function viewOrder(id) {
    app.showLoading('جاري تحميل تفاصيل الطلب...');

    try {
        const sale = await app.apiRequest(`/api/sales/${id}/`);
        console.log('Sale details:', sale);

        app.hideLoading();

        // إنشاء HTML لتفاصيل الطلب
        let itemsHtml = '';
        let subtotal = 0;

        if (sale.items && sale.items.length > 0) {
            sale.items.forEach(item => {
                const itemTotal = parseFloat(item.total_price);
                subtotal += itemTotal;
                itemsHtml += `
                    <tr>
                        <td>${item.part_name || item.inventory_item_details?.part?.name || 'غير معروف'}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-end">${parseFloat(item.unit_price).toFixed(2)}</td>
                        <td class="text-end"><strong>${itemTotal.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
        }

        const currencySymbol = 'EGP';

        const modalHtml = `
            <div class="modal fade" id="viewOrderModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-receipt me-2"></i>
                                تفاصيل الطلب - ${sale.invoice_number}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted">معلومات العميل</h6>
                                    <p class="mb-1"><strong>الاسم:</strong> ${sale.customer_details?.first_name || ''} ${sale.customer_details?.last_name || ''}</p>
                                    <p class="mb-1"><strong>الهاتف:</strong> ${sale.customer_details?.phone || '-'}</p>
                                    <p class="mb-1"><strong>العنوان:</strong> ${sale.customer_details?.address || '-'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">معلومات الطلب</h6>
                                    <p class="mb-1"><strong>التاريخ:</strong> ${new Date(sale.created_at).toLocaleDateString('ar-EG')}</p>
                                    <p class="mb-1"><strong>الحالة:</strong> <span class="badge bg-${sale.status === 'COMPLETED' ? 'success' : sale.status === 'DRAFT' ? 'warning' : 'secondary'}">${sale.status_display}</span></p>
                                    <p class="mb-1"><strong>حالة الدفع:</strong> <span class="badge bg-${sale.payment_status === 'PAID' ? 'success' : sale.payment_status === 'PARTIAL' ? 'warning' : 'danger'}">${sale.payment_status_display}</span></p>
                                    <p class="mb-1"><strong>البائع:</strong> ${sale.sales_person_name || '-'}</p>
                                </div>
                            </div>

                            <h6 class="text-muted mb-3">القطع المباعة</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>القطعة</th>
                                            <th class="text-center">الكمية</th>
                                            <th class="text-end">السعر</th>
                                            <th class="text-end">الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${itemsHtml}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>المجموع الفرعي:</strong></td>
                                            <td class="text-end"><strong>${parseFloat(sale.subtotal).toFixed(2)} ${currencySymbol}</strong></td>
                                        </tr>
                                        ${sale.discount_amount > 0 ? `
                                        <tr>
                                            <td colspan="3" class="text-end">الخصم:</td>
                                            <td class="text-end text-danger">-${parseFloat(sale.discount_amount).toFixed(2)} ${currencySymbol}</td>
                                        </tr>
                                        ` : ''}
                                        ${sale.tax_amount > 0 ? `
                                        <tr>
                                            <td colspan="3" class="text-end">الضريبة:</td>
                                            <td class="text-end">+${parseFloat(sale.tax_amount).toFixed(2)} ${currencySymbol}</td>
                                        </tr>
                                        ` : ''}
                                        <tr class="table-primary">
                                            <td colspan="3" class="text-end"><strong>الإجمالي الكلي:</strong></td>
                                            <td class="text-end"><strong>${parseFloat(sale.total_amount).toFixed(2)} ${currencySymbol}</strong></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td colspan="3" class="text-end">المدفوع:</td>
                                            <td class="text-end">${parseFloat(sale.paid_amount).toFixed(2)} ${currencySymbol}</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td colspan="3" class="text-end"><strong>المتبقي:</strong></td>
                                            <td class="text-end"><strong>${parseFloat(sale.balance_due).toFixed(2)} ${currencySymbol}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            ${sale.notes ? `
                            <div class="mt-3">
                                <h6 class="text-muted">ملاحظات</h6>
                                <p class="border p-2 rounded">${sale.notes}</p>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            <button type="button" class="btn btn-success" onclick="printOrder(${id})">
                                <i class="bi bi-printer me-2"></i>
                                طباعة الفاتورة
                            </button>
                            ${sale.status === 'DRAFT' || sale.status === 'CONFIRMED' ? `
                            <button type="button" class="btn btn-primary" onclick="completeOrder(${id})">
                                <i class="bi bi-check-circle me-2"></i>
                                إتمام الطلب
                            </button>
                            <button type="button" class="btn btn-danger" onclick="cancelOrder(${id})">
                                <i class="bi bi-x-circle me-2"></i>
                                إلغاء الطلب
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // إضافة وعرض النافذة
        const container = document.getElementById('action-modal-container');
        container.insertAdjacentHTML('beforeend', modalHtml);

        const modal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
        modal.show();

        // حذف النافذة عند الإغلاق
        document.getElementById('viewOrderModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });

    } catch (error) {
        console.error('Error loading order details:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'خطأ',
            message: `فشل تحميل تفاصيل الطلب: ${error.message || 'خطأ غير معروف'}`,
            type: 'error'
        });
    }
}

// إتمام الطلب
async function completeOrder(id) {
    // ✅ التحقق من حالة الدفع أولاً
    app.showLoading('جاري التحقق من الطلب...');

    try {
        const sale = await app.apiRequest(`/api/sales/${id}/`);
        app.hideLoading();

        const totalAmount = parseFloat(sale.total_amount || 0);
        const paidAmount = parseFloat(sale.paid_amount || 0);
        const balanceDue = parseFloat(sale.balance_due || 0);
        const paymentStatus = sale.payment_status;

        // إذا كان الطلب غير مدفوع أو مدفوع جزئياً، اطلب الدفع
        if (paymentStatus !== 'PAID' && balanceDue > 0) {
            const shouldPay = await actionModals.showConfirmModal({
                title: '⚠️ الطلب غير مدفوع',
                message: `المبلغ الإجمالي: ${totalAmount.toFixed(2)} ${'EGP'}\nالمدفوع: ${paidAmount.toFixed(2)} ${'EGP'}\nالمتبقي: ${balanceDue.toFixed(2)} ${'EGP'}\n\nيجب دفع المبلغ المتبقي قبل إتمام الطلب.\nهل تريد إضافة دفعة الآن؟`,
                confirmText: 'نعم، إضافة دفعة',
                cancelText: 'إلغاء'
            });

            if (!shouldPay) return;

            // عرض نافذة الدفع للمبلغ المتبقي
            showPaymentModalForCompletion(sale, balanceDue);
            return;
        }

        // إذا كان مدفوعاً بالكامل، تأكيد الإتمام
        const confirmed = await actionModals.showConfirmModal({
            title: 'تأكيد إتمام الطلب',
            message: 'هل أنت متأكد من إتمام هذا الطلب؟ سيتم خصم الكميات من المخزون.',
            confirmText: 'نعم، إتمام',
            cancelText: 'إلغاء'
        });

        if (!confirmed) return;

        app.showLoading('جاري إتمام الطلب...');

        const result = await app.apiRequest(`/api/sales/${id}/complete/`, {
            method: 'POST'
        });

        app.hideLoading();

        actionModals.showInfoModal({
            title: 'تم الإتمام! ✅',
            message: 'تم إتمام الطلب بنجاح وخصم الكميات من المخزون',
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error completing order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'خطأ',
            message: `فشل إتمام الطلب: ${error.message || 'خطأ غير معروف'}`,
            type: 'error'
        });
    }
}

// عرض نافذة الدفع عند محاولة إتمام طلب غير مدفوع
function showPaymentModalForCompletion(sale, requiredAmount) {
    const currencySymbol = 'EGP';

    const modalHtml = `
        <div class="modal fade" id="completionPaymentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">⚠️ دفع مطلوب - ${sale.invoice_number}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            يجب دفع المبلغ المتبقي قبل إتمام الطلب
                        </div>

                        <div class="mb-3">
                            <h6>المبلغ الإجمالي:</h6>
                            <h4 class="text-primary">${parseFloat(sale.total_amount).toFixed(2)} ${currencySymbol}</h4>
                        </div>

                        <div class="mb-3">
                            <h6>المدفوع سابقاً:</h6>
                            <h5 class="text-success">${parseFloat(sale.paid_amount || 0).toFixed(2)} ${currencySymbol}</h5>
                        </div>

                        <div class="mb-3">
                            <h6>المبلغ المطلوب:</h6>
                            <h3 class="text-danger">${requiredAmount.toFixed(2)} ${currencySymbol}</h3>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">المبلغ المدفوع <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="completionPaidAmount"
                                   min="${requiredAmount}" max="${requiredAmount}" step="0.01"
                                   value="${requiredAmount}" required>
                            <small class="text-muted">يجب دفع المبلغ المتبقي بالكامل</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">طريقة الدفع <span class="text-danger">*</span></label>
                            <select class="form-select" id="completionPaymentMethod" required>
                                <option value="CASH">نقداً</option>
                                <option value="CARD">بطاقة ائتمان</option>
                                <option value="BANK_TRANSFER">تحويل بنكي</option>
                                <option value="CHEQUE">شيك</option>
                            </select>
                        </div>

                        <div class="mb-3" id="completionReferenceNumberDiv" style="display: none;">
                            <label class="form-label">رقم المرجع</label>
                            <input type="text" class="form-control" id="completionReferenceNumber"
                                   placeholder="رقم الشيك / رقم التحويل">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="completionPaymentNotes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            إلغاء
                        </button>
                        <button type="button" class="btn btn-success" onclick="processCompletionPayment(${sale.id}, ${requiredAmount})">
                            <i class="bi bi-check-circle me-2"></i>
                            دفع وإتمام الطلب
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // إضافة النافذة للصفحة
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    // عرض النافذة
    const modal = new bootstrap.Modal(document.getElementById('completionPaymentModal'));
    modal.show();

    // إزالة النافذة عند الإغلاق
    document.getElementById('completionPaymentModal').addEventListener('hidden.bs.modal', function() {
        modalContainer.remove();
    });

    // إظهار حقل رقم المرجع للطرق التي تحتاجه
    document.getElementById('completionPaymentMethod').addEventListener('change', function() {
        const refDiv = document.getElementById('completionReferenceNumberDiv');
        if (['CARD', 'BANK_TRANSFER', 'CHEQUE'].includes(this.value)) {
            refDiv.style.display = 'block';
        } else {
            refDiv.style.display = 'none';
        }
    });
}

// معالجة الدفع وإتمام الطلب
async function processCompletionPayment(saleId, requiredAmount) {
    const paidAmount = parseFloat(document.getElementById('completionPaidAmount').value) || 0;
    const paymentMethod = document.getElementById('completionPaymentMethod').value;
    const referenceNumber = document.getElementById('completionReferenceNumber').value;
    const notes = document.getElementById('completionPaymentNotes').value;

    if (paidAmount < requiredAmount) {
        actionModals.showInfoModal({
            title: 'تحذير',
            message: `يجب دفع المبلغ المتبقي بالكامل (${requiredAmount.toFixed(2)} ${'EGP'})`,
            type: 'warning'
        });
        return;
    }

    app.showLoading('جاري معالجة الدفع وإتمام الطلب...');

    try {
        // 1. إضافة الدفعة
        const paymentData = {
            amount: paidAmount,
            payment_method: paymentMethod,
            reference_number: referenceNumber,
            notes: notes
        };

        await app.apiRequest(`/api/sales/${saleId}/add_payment/`, {
            method: 'POST',
            body: JSON.stringify(paymentData)
        });

        // 2. إتمام الطلب
        await app.apiRequest(`/api/sales/${saleId}/complete/`, {
            method: 'POST'
        });

        app.hideLoading();

        // إغلاق نافذة الدفع
        const modal = bootstrap.Modal.getInstance(document.getElementById('completionPaymentModal'));
        modal.hide();

        // عرض رسالة نجاح
        actionModals.showInfoModal({
            title: 'تم بنجاح! ✅',
            message: `تم تسجيل الدفع وإتمام الطلب بنجاح\nالمبلغ المدفوع: ${paidAmount.toFixed(2)} ${'EGP'}`,
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error processing completion payment:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'خطأ',
            message: `فشل معالجة الدفع: ${error.message || 'خطأ غير معروف'}`,
            type: 'error'
        });
    }
}

// إلغاء الطلب
async function cancelOrder(id) {
    const confirmed = await actionModals.showConfirmModal({
        title: 'تأكيد إلغاء الطلب',
        message: 'هل أنت متأكد من إلغاء هذا الطلب؟ سيتم إلغاء حجز القطع وإعادتها للمخزون.',
        confirmText: 'نعم، إلغاء الطلب',
        cancelText: 'رجوع'
    });

    if (!confirmed) return;

    app.showLoading('جاري إلغاء الطلب...');

    try {
        const result = await app.apiRequest(`/api/sales/${id}/cancel/`, {
            method: 'POST'
        });

        app.hideLoading();

        actionModals.showInfoModal({
            title: 'تم الإلغاء ✅',
            message: 'تم إلغاء الطلب بنجاح وإعادة القطع للمخزون',
            type: 'success',
            onClose: () => location.reload()
        });

    } catch (error) {
        console.error('Error cancelling order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'خطأ',
            message: `فشل إلغاء الطلب: ${error.message || 'خطأ غير معروف'}`,
            type: 'error'
        });
    }
}

// طباعة طلب
async function printOrder(id) {
    app.showLoading('جاري تحضير الفاتورة للطباعة...');

    try {
        const sale = await app.apiRequest(`/api/sales/${id}/`);

        app.hideLoading();

        // إنشاء نافذة الطباعة
        const printWindow = window.open('', '_blank', 'width=800,height=600');

        let itemsHtml = '';
        let subtotal = 0;

        if (sale.items && sale.items.length > 0) {
            sale.items.forEach((item, index) => {
                const itemTotal = parseFloat(item.total_price);
                subtotal += itemTotal;
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.part_name || item.inventory_item_details?.part?.name || 'غير معروف'}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-end">${parseFloat(item.unit_price).toFixed(2)}</td>
                        <td class="text-end"><strong>${itemTotal.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
        }

        const currencySymbol = 'EGP';
        const currentDate = new Date().toLocaleDateString('ar-EG');

        const printContent = `
            <!DOCTYPE html>
            <html dir="rtl" lang="ar">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>فاتورة - ${sale.invoice_number}</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        padding: 20px;
                        direction: rtl;
                    }
                    .invoice-header {
                        text-align: center;
                        margin-bottom: 30px;
                        border-bottom: 3px solid #333;
                        padding-bottom: 20px;
                    }
                    .invoice-header h1 {
                        color: #2c3e50;
                        margin-bottom: 10px;
                    }
                    .invoice-header p {
                        color: #7f8c8d;
                        font-size: 14px;
                    }
                    .invoice-info {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 30px;
                    }
                    .info-section {
                        flex: 1;
                    }
                    .info-section h3 {
                        color: #2c3e50;
                        margin-bottom: 10px;
                        font-size: 16px;
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 5px;
                    }
                    .info-section p {
                        margin: 5px 0;
                        font-size: 14px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                    }
                    th, td {
                        border: 1px solid #ddd;
                        padding: 12px;
                        text-align: right;
                    }
                    th {
                        background-color: #3498db;
                        color: white;
                        font-weight: bold;
                    }
                    .text-center {
                        text-align: center;
                    }
                    .text-end {
                        text-align: left;
                    }
                    .totals {
                        margin-top: 20px;
                        float: left;
                        width: 300px;
                    }
                    .totals table {
                        margin-bottom: 0;
                    }
                    .totals td {
                        padding: 8px;
                    }
                    .total-row {
                        background-color: #ecf0f1;
                        font-weight: bold;
                        font-size: 16px;
                    }
                    .section-title {
                        margin-bottom: 15px;
                        color: #2c3e50;
                    }
                    .row-discount {
                        color: #e74c3c;
                        font-weight: 600;
                    }
                    .row-paid {
                        background-color: #d5f4e6;
                    }
                    .row-remaining {
                        background-color: #fff3cd;
                    }
                    .footer {
                        clear: both;
                        margin-top: 50px;
                        text-align: center;
                        padding-top: 20px;
                        border-top: 2px solid #333;
                        color: #7f8c8d;
                        font-size: 12px;
                    }
                    .badge {
                        display: inline-block;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: bold;
                    }
                    .badge-success {
                        background-color: #27ae60;
                        color: white;
                    }
                    .badge-warning {
                        background-color: #f39c12;
                        color: white;
                    }
                    .badge-danger {
                        background-color: #e74c3c;
                        color: white;
                    }
                    @media print {
                        body {
                            padding: 0;
                        }
                        .no-print {
                            display: none;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-header">
                    <h1>🚗 SH Parts - فاتورة مبيعات</h1>
                    <p>نظام إدارة قطع غيار السيارات</p>
                </div>

                <div class="invoice-info">
                    <div class="info-section">
                        <h3>معلومات الفاتورة</h3>
                        <p><strong>رقم الفاتورة:</strong> ${sale.invoice_number}</p>
                        <p><strong>التاريخ:</strong> ${new Date(sale.created_at).toLocaleDateString('ar-EG')}</p>
                        <p><strong>الحالة:</strong> <span class="badge badge-${sale.status === 'COMPLETED' ? 'success' : sale.status === 'DRAFT' ? 'warning' : 'secondary'}">${sale.status_display}</span></p>
                        <p><strong>حالة الدفع:</strong> <span class="badge badge-${sale.payment_status === 'PAID' ? 'success' : sale.payment_status === 'PARTIAL' ? 'warning' : 'danger'}">${sale.payment_status_display}</span></p>
                    </div>

                    <div class="info-section">
                        <h3>معلومات العميل</h3>
                        <p><strong>الاسم:</strong> ${sale.customer_details?.first_name || ''} ${sale.customer_details?.last_name || ''}</p>
                        <p><strong>الهاتف:</strong> ${sale.customer_details?.phone || '-'}</p>
                        <p><strong>العنوان:</strong> ${sale.customer_details?.address || '-'}</p>
                        <p><strong>البائع:</strong> ${sale.sales_person_name || '-'}</p>
                    </div>
                </div>

                <h3 class="section-title">تفاصيل القطع</h3>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>اسم القطعة</th>
                            <th class="text-center" style="width: 100px;">الكمية</th>
                            <th class="text-end" style="width: 120px;">السعر</th>
                            <th class="text-end" style="width: 120px;">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <div class="totals">
                    <table>
                        <tr>
                            <td><strong>المجموع الفرعي:</strong></td>
                            <td class="text-end"><strong>${parseFloat(sale.subtotal).toFixed(2)} ${currencySymbol}</strong></td>
                        </tr>
                        ${sale.discount_amount > 0 ? `
                        <tr>
                            <td>الخصم:</td>
                            <td class="text-end row-discount">-${parseFloat(sale.discount_amount).toFixed(2)} ${currencySymbol}</td>
                        </tr>
                        ` : ''}
                        ${sale.tax_amount > 0 ? `
                        <tr>
                            <td>الضريبة:</td>
                            <td class="text-end">+${parseFloat(sale.tax_amount).toFixed(2)} ${currencySymbol}</td>
                        </tr>
                        ` : ''}
                        <tr class="total-row">
                            <td><strong>الإجمالي الكلي:</strong></td>
                            <td class="text-end"><strong>${parseFloat(sale.total_amount).toFixed(2)} ${currencySymbol}</strong></td>
                        </tr>
                        <tr class="row-paid">
                            <td>المدفوع:</td>
                            <td class="text-end">${parseFloat(sale.paid_amount).toFixed(2)} ${currencySymbol}</td>
                        </tr>
                        <tr class="row-remaining">
                            <td><strong>المتبقي:</strong></td>
                            <td class="text-end"><strong>${parseFloat(sale.balance_due).toFixed(2)} ${currencySymbol}</strong></td>
                        </tr>
                    </table>
                </div>

                <div class="footer">
                    <p>شكراً لتعاملكم معنا</p>
                    <p>تاريخ الطباعة: ${currentDate}</p>
                    <p>SH Parts - نظام إدارة قطع غيار السيارات</p>
                </div>

                <div class="no-print" style="text-align: center; margin-top: 30px;">
                    <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        طباعة
                    </button>
                    <button onclick="window.close()" style="padding: 10px 30px; font-size: 16px; background-color: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        إغلاق
                    </button>
                </div>
            </body>
            </html>
        `;

        printWindow.document.write(printContent);
        printWindow.document.close();

        // طباعة تلقائية بعد التحميل
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.print();
            }, 250);
        };

    } catch (error) {
        console.error('Error printing order:', error);
        app.hideLoading();
        actionModals.showInfoModal({
            title: 'خطأ',
            message: `فشل تحضير الفاتورة للطباعة: ${error.message || 'خطأ غير معروف'}`,
            type: 'error'
        });
    }
}
</script>
{% endblock %}
